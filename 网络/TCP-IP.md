# 体系结构
![TCP/IP体系结构](https://github.com/lmwis/data-structure-and-algorithm/blob/main/%E7%BD%91%E7%BB%9C/pic/TCPIP%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84.png)
### 1.四层协议
- **网络接口层**：相当于五层协议中数据链路层和物理层的合并
    - **物理层**：使用何种物理线路，不同的线路，带宽、可靠性、安全性、延迟等会有所不同。物理层的作用是尽可能屏蔽传输媒体和通信手段的差异，把模拟信号转化为01数字比特流，使数据链路层感觉不到这些差异。
    - **数据链路层**：网络层针对的还是主机之间的数据传输服务，而主机之间可以有很多链路，链路层协议就是为同一链路的主机提供数据传输服务。数据链路层把网络层传下来的分组封装成帧。
- **网络层**：数据链路只负责某一个区间的通信传输，网络层负责将**IP数据包**发给最终的目的地址，即点对点通信。
    - 1.IP属于**面向无连接**形，为了**简化**和**提速**。需要连接时通过委托上一层来实现
    - 2.通常一个传输层的数据会在网络层进行**分片**，在所有主机和路由器上都可以进行分片，但只在目标主机上进行重组
    - 3.向上通过**DNS**解析为IP地址，向下通过**ARP**获取MAC地址
    - 4.通过**ICMP**协议来诊断网络中的问题
    - 5.**DHCP**协议让连接到网络的计算机自动分配IP地址
    - 6.**NAT**缓解了IPv4地址的枯竭，是用于在本地网络中使用私有地址，在连接互联网时转而使用全局IP地址的技术
    - 7.**IP隧道**：在网络层首部的后面追加网络层首部，是为了中间被IPv4阻断的两个网络之间通信
- **传输层**：两个代表性的传输层协议**TCP**和**UDP**
    - 1.TCP：传输控制协议，**面向连接**，**可靠的流协议**，**无状态**。为提供可靠性传输，实现“顺序控制”或“重发控制”机制，还具有“流控制”，“拥塞控制”
    - 2.UDP：用户数据报协议，具有不可靠性，可以保证发送数据的大小，但**不保证数据一定能到达**
    - 3.RIP,DHCP,DNS都使用UDP协议
    - 4.TCP三次握手
        - 1)**为什么初始序列号是随机的**：序列号是随机生成的为了防止黑客获取到初始序列号从而伪造序列号进行攻击
        - 2)确认应答号是序列号+1，也就是下次发送的序列号第一个
        - 3)第三次握手是为了防止失效的连接请求到达服务器，让服务器错误打开连接。
    - 5.TCP四次挥手
        - 1)A 发送连接释放报文，FIN=1。
        - 2)B 收到之后发出确认，此时 TCP 属于半关闭状态，B 能向 A 发送数据但是 A 不能向 B 发送数据。
        - 3)当 B 不再需要连接时，发送连接释放报文，FIN=1。
        - 4)A 收到后发出确认，进入 TIME-WAIT 状态，等待 2 MSL（最大报文存活时间）后释放连接。
        - 5)B 收到 A 的确认后释放连接。
        - 6)**TIME_WAIT**：客户端接收到服务器端的 FIN 报文后进入此状态，此时并不是直接进入 CLOSED 状态，还需要等待一个时间计时器设置的时间 2MSL。这么做有两个理由：
            - 确保最后一个确认报文能够到达。如果 B 没收到 A 发送来的确认报文，那么就会重新发送连接释放请求报文，A 等待一段时间就是为了处理这种情况的发生。
            - 等待一段时间是为了让本连接持续时间内所产生的所有报文都从网络中消失，使得下一个新的连接不会出现旧的连接请求报文。
    - 6.若未收到确认应答，会进行**超时重发**，超时重发的时间=往返时间(RTT)+偏差，单位是0.5秒，因此重发时间是0.5秒的整数倍，最小重发时间为1秒，一般为6秒
    - 7.**滑动窗口**：以更大的单位进行应答，由于使用了窗口，某些确认应答即使丢失也无需重发
    - 8.**快重传**：滑动窗口基础上，如果连续三次收到同一个确认应答，就会立即对对应数据进行重发
        - **为什么是三次**：因为两次可能是因为网络问题而导致数据先后顺序不一样
    - 9.**流量控制**：根据接收端负载情况动态改变滑动窗口大小
    - 10.**拥塞控制**：
        - **慢启动**：每收到一个确认应答，拥塞窗口的值增加一个段，因此在整个网络刚启动的时候，包的数量指数级增长
        - **拥塞控制阈值**：当拥塞窗口大于阈值时，使得拥塞窗口每次+1成为线性增长，当网络中发生拥塞时，将阈值设置为当前拥塞窗口的一半，然后重新开始
        - **快恢复**：当传输中丢失某个报文段时，会执行快重传，进行数据重发，随之执行快恢复，使得拥塞控制阈值为拥塞窗口的一半，而直接使拥塞窗口成为当前阈值进入线性增长，而不是重新开始